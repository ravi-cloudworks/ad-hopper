<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Merger</title>
    <style>
        .container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }
        .log {
            margin-top: 20px;
            text-align: left;
            white-space: pre-wrap;
            font-family: monospace;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
    <script src="/assets/ffmpeg/package/dist/umd/ffmpeg.js"></script>
    <script src="/assets/util/package/dist/umd/index.js"></script>
</head>
<body>
    <div class="container">
        <h2>Video Merger</h2>
        <input type="file" id="file-input" multiple accept="video/*">
        <button id="merge-button">Merge Videos</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        const { fetchFile } = FFmpegUtil;
        const { FFmpeg } = FFmpegWASM;
        let ffmpeg = null;

        const fileInput = document.getElementById('file-input');
        const mergeButton = document.getElementById('merge-button');
        const logDiv = document.getElementById('log');

        function log(msg) {
            logDiv.textContent += msg + '\n';
            console.log(msg);
        }

        async function initFFmpeg() {
            if (!ffmpeg) {
                ffmpeg = new FFmpeg();
                ffmpeg.on("log", ({ message }) => {
                    console.log(message);
                });

                await ffmpeg.load({
                    coreURL: "/assets/core/package/dist/umd/ffmpeg-core.js",
                });
            }
        }

        async function mergeVideos() {
            const files = Array.from(fileInput.files);
            if (files.length < 2) {
                alert('Please select at least 2 video files');
                return;
            }

            try {
                mergeButton.disabled = true;
                log('Starting merge process...');

                await initFFmpeg();

                // Write input files
                for (let i = 0; i < files.length; i++) {
                    const inputName = `input${i}.mp4`;
                    await ffmpeg.writeFile(inputName, await fetchFile(files[i]));
                    log(`Loaded file ${i + 1}: ${files[i].name}`);
                }

                // Create intermediate TS files
                log('\nConverting to intermediate format...');
                for (let i = 0; i < files.length; i++) {
                    await ffmpeg.exec([
                        '-i', `input${i}.mp4`,
                        '-c', 'copy',
                        '-bsf:v', 'h264_mp4toannexb',
                        '-f', 'mpegts',
                        `temp${i}.ts`
                    ]);
                    log(`Converted file ${i + 1} to intermediate format`);
                }

                // Simple concatenation of TS files using cat
                log('\nConcatenating files...');
                await ffmpeg.exec([
                    '-i', 'concat:temp0.ts|temp1.ts',
                    '-c', 'copy',
                    '-bsf:a', 'aac_adtstoasc',
                    '-y',
                    'output.mp4'
                ]);

                // Get and verify output file
                const data = await ffmpeg.readFile('output.mp4');
                const outputSize = data.length / (1024 * 1024);
                log(`\nOutput file size: ${outputSize.toFixed(2)} MB`);

                // Create download
                const blob = new Blob([data], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'merged_video.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                log('\nMerge complete! Video downloaded.');

            } catch (error) {
                console.error('Error:', error);
                log('Error: ' + error.message);
            } finally {
                mergeButton.disabled = false;
            }
        }

        mergeButton.addEventListener('click', mergeVideos);
    </script>
</body>
</html>